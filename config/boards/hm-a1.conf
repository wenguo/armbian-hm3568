# Rockchip RK3399 hexa core 3/4GB RAM SoC GBE eMMC USB3 USB-C WiFi/BT
# Uses the same u-boot dtb from Orangepi4 original board, but sets
# specific kernel DTB with BOOT_FDT_FILE directive
BOARD_NAME="HEMAI R3399A1"
BOARDFAMILY="rockchip64" # Used to be rk3399
BOARD_MAINTAINER="wenguoliu"
BOOTCONFIG="evb-rk3399_defconfig"
BOOT_FDT_FILE="rockchip/rk3399-hm-a1.dtb"
KERNEL_TARGET="current,edge"
FULL_DESKTOP="yes"
ASOUND_STATE="asound.state.rt5651"
BOOT_LOGO="desktop"
BOOTBRANCH_BOARD="tag:v2022.04"
BOOTPATCHDIR="u-boot-rockchip64-v2022.04"

#declare -g KERNEL_MAJOR_MINOR="6.1"    # Major and minor versions of this kernel.
#declare -g -i KERNEL_GIT_CACHE_TTL=120 # 2 minutes; this is a high-traffic repo
#KERNELSOURCE='https://github.com/armbian/linux-rockchip.git'
#KERNELBRANCH="branch:rk-6.1-rkr1"
#KERNELPATCHDIR="rockchip-vendor-6.1"

#enable_extension "mesa-vpu"

function post_family_tweaks_bsp__hm_a1() {
	display_alert "Installing BSP firmware and fixups"

	return 0
}


# function post_family_config_branch_hm_s039_kernel() {
# 	declare -g KERNELSOURCE='https://github.com/armbian/linux-rockchip'
# 	declare -g KERNEL_MAJOR_MINOR="6.1" # Major and minor versions of this kernel.
# 	declare -g KERNELBRANCH="branch:rk-6.1-rkr1"
# 	display_alert "Setting up kernel ${KERNEL_MAJOR_MINOR} for" "${BOARD}" "info"
# }

function post_family_tweaks_bsp__use_correct_bluetooth_firmware() {
	run_host_command_logged mkdir -pv --mode=755 "$destination/lib/firmware/" || exit_with_error "Unable to mkdir firmware"
	run_host_command_logged mkdir -v --mode=775 "$destination/lib/firmware/brcm/" || exit_with_error "Unable to mkdir brcm"
	run_host_command_logged ln -sf /lib/firmware/brcm/brcmfmac4356-sdio-nanopi-m4v2.bin "${destination}"/lib/firmware/brcm/brcmfmac4356-sdio.roymark,hemei-a1.bin
	run_host_command_logged ln -sf /lib/firmware/brcm/brcmfmac4356-sdio-nanopi-m4v2.txt "${destination}"/lib/firmware/brcm/brcmfmac4356-sdio.roymark,hemei-a1.txt
}

function post_family_tweaks_bsp__hm-a1_install_ids_dependency() {
	display_alert "$BOARD" "install IDS dependency" "info"
	mkdir -p $destination/usr/share/fonts
	mkdir -p $destination/usr/local/share
	mkdir -p $destination/usr/local/share/applications
	mkdir -p $destination/usr/lib/systemd/system/

	run_host_command_logged tar xzf $SRC/packages/bsp/hemai/winfonts.tar.gz -C $destination/usr/share/fonts
	run_host_command_logged tar xzf $SRC/packages/bsp/hemai/noVNC.tgz -C $destination/usr/local/share


	install -Dm644 $SRC/packages/bsp/hemai/x11vnc.service $destination/usr/lib/systemd/system/
	install -Dm644 $SRC/packages/bsp/hemai/novnc.service $destination/usr/lib/systemd/system/
	install -Dm644 $SRC/packages/bsp/hemai/wol@.service $destination/usr/lib/systemd/system//
	install -Dm644 $SRC/packages/bsp/hemai/idslinux.desktop $destination/usr/local/share/applications/
	install -Dm644 $SRC/packages/bsp/hemai/idskiller.desktop $destination/usr/local/share/applications/

}
## Modules, required to boot, add them to initrd
function post_family_tweaks_bsp__hm-a1_modules() {
	display_alert "Adding to " "${BOARD}: modules " "info"
	add_file_from_stdin_to_bsp_destination "/etc/modules" <<- 'EXTRA_MODULES'
		extcon_usbc_virtual_pd
	EXTRA_MODULES
}


function post_family_tweaks__preset_configs() {
	display_alert "$BOARD" "preset configs for rootfs" "info"
	# Set PRESET_NET_CHANGE_DEFAULTS to 1 to apply any network related settings below
	echo "PRESET_NET_CHANGE_DEFAULTS=1" > "${SDCARD}"/root/.not_logged_in_yet

	# Enable WiFi or Ethernet.
	#      NB: If both are enabled, WiFi will take priority and Ethernet will be disabled.
	# echo "PRESET_NET_ETHERNET_ENABLED=0" >> "${SDCARD}"/root/.not_logged_in_yet
	# echo "PRESET_NET_WIFI_ENABLED=1" >> "${SDCARD}"/root/.not_logged_in_yet

	# Preset user default shell, you can choose bash or zsh
	echo "PRESET_USER_SHELL=bash" >> "${SDCARD}"/root/.not_logged_in_yet

	# Set PRESET_CONNECT_WIRELESS=y if you want to connect wifi manually at first login
	echo "PRESET_CONNECT_WIRELESS=n" >> "${SDCARD}"/root/.not_logged_in_yet

	# Set SET_LANG_BASED_ON_LOCATION=n if you want to choose "Set user language based on your location?" with "n" at first login
	echo "SET_LANG_BASED_ON_LOCATION=y" >> "${SDCARD}"/root/.not_logged_in_yet

	# Preset default locale
	echo "PRESET_LOCALE=zh_CN.UTF-8" >> "${SDCARD}"/root/.not_logged_in_yet

	# Preset timezone
	echo "PRESET_TIMEZONE=Asia/Shanghai" >> "${SDCARD}"/root/.not_logged_in_yet

	# Preset root password
	echo "PRESET_ROOT_PASSWORD=admin" >> "${SDCARD}"/root/.not_logged_in_yet

	# Preset username
	echo "PRESET_USER_NAME=roymark" >> "${SDCARD}"/root/.not_logged_in_yet

	# Preset user password
	echo "PRESET_USER_PASSWORD=123456" >> "${SDCARD}"/root/.not_logged_in_yet

	# Preset user default realname
	echo "PRESET_DEFAULT_REALNAME=Roymark" >> "${SDCARD}"/root/.not_logged_in_yet

}


function post_family_tweaks__hm-a1_install_extra_packages() {

	display_alert "$BOARD" "install extra packages" "info"

	do_with_retries 2 chroot_sdcard_apt_get_update
	do_with_retries 2 chroot_sdcard_apt_get_install libjsoncpp25 libmd4c0 libb2-1 libxcb-cursor0 libxcb-icccm4 libxcb-keysyms1 v4l-utils libass9
	do_with_retries 2 chroot_sdcard_apt_get_install libass9 libplacebo192 libvulkan1 libopengl0 libgles2-mesa libxss1
	do_with_retries 2 chroot_sdcard_apt_get_install libdouble-conversion3 libpcre2-16-0 ntp

	chroot_sdcard systemctl enable wol@eth1
	chroot_sdcard systemctl enable wol@enp1s0


	do_with_retries 2 chroot_sdcard_apt_get_install x11vnc websockify
	chroot_sdcard systemctl enable x11vnc.service
	chroot_sdcard systemctl enable novnc.service
	run_host_command_logged install -Dm644 $SRC/packages/bsp/hemai/idslinux.desktop "${SDCARD}"/etc/xdg/autostart/
	run_host_command_logged install -Dm644 $SRC/packages/bsp/hemai/xfce4-session.xml "${SDCARD}"/etc/xdg/xfce4/xfconf/xfce-perchannel-xml/
	run_host_command_logged install -Dm644 $SRC/packages/bsp/hemai/x11vnc.pass "${SDCARD}"/etc/
	run_host_command_logged install -Dm644 $SRC/packages/bsp/hemai/idslinux.tar.gz "${SDCARD}"/root/

	return 0

}

function pre_umount_final_image__update_fstab() {
	display_alert "Update fstab settings for " "${BOARD}" "info"
	run_host_command_logged echo "PARTLABEL=userdata /opt ext4 defaults 0 0" >> "${MOUNT}"/etc/fstab
}
